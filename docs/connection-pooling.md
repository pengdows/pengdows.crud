# Connection Pooling and Governors

## Pooling defaults
`DatabaseContext` automatically rewrites connection strings for Standard and KeepAlive modes so sockets and clients stay in a managed pool. `ConnectionPoolingConfiguration.ApplyPoolingDefaults` detects whether the provider supports external pooling, skips raw connection strings (like `:memory:` or a bare file path), forces `Pooling=true` when the flag is missing, and ensures `Min Pool Size=1` unless pooling is explicitly disabled or already configured. These defaults guarantee that a connection is always available when the context needs it, but they respect your existing pooling settings when you have custom values or pooling is intentionally turned off.【F:pengdows.crud/internal/ConnectionPoolingConfiguration.cs†L15-L199】

## Pool governors
Whenever pooling is enabled the context creates read and write `PoolGovernor` instances that issue `PoolPermit` tokens before any connection is acquired. Each governor waits no longer than `PoolAcquireTimeout` (default 5 seconds via `DatabaseContextConfiguration.PoolAcquireTimeout`) before throwing a `PoolSaturatedException` with queue and permit statistics, so you fail fast instead of saturating the provider pool. Override `ReadPoolSize`/`WritePoolSize` or disable the governors (`EnablePoolGovernor=false`) to hydrate custom limits, and observe the snapshots if you need to correlate hot paths with pool contention.【F:pengdows.crud/infrastructure/PoolGovernor.cs†L10-L194】【F:pengdows.crud/exceptions/PoolSaturatedException.cs†L7-L21】【F:pengdows.crud/configuration/DatabaseContextConfiguration.cs†L66-L70】

## Pinned connections keep permits
`InitializePoolGovernors` hashes the writer and reader connection strings to get pooled keys, respects the resolved pool size (including overrides) and the selected `DbMode`, and transparently shares the same semaphore for both governors when the connection strings match. `SingleWriter` mode now uses the Standard lifecycle but adjusts the governor so writes serialize with `MaxConcurrentWrites = 1` (and an optional writer-preference turnstile); `SingleConnection` and `KeepAlive` still adjust their permit counts to account for their persistent connections, and `AttachPinnedPermitIfNeeded` runs only for those modes. This keeps the governors aware of the pinned connections while still allowing other operations to proceed, and the hashed key ensures each unique connection string gets its own governor scope.【F:pengdows.crud/DatabaseContext.Initialization.cs†L552-L662】
